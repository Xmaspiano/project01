<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
    <title>select</title>

    <!-- Bootstrap -->
    <link href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">

    <!-- HTML5 shim 和 Respond.js 是为了让 IE8 支持 HTML5 元素和媒体查询（media queries）功能 -->
    <!-- 警告：通过 file:// 协议（就是直接将 html 页面拖拽到浏览器中）访问页面时 Respond.js 不起作用 -->
    <!--[if lt IE 9]>
    <script src="https://cdn.bootcss.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
<div class="container">
    <h2>四川路桥桥梁工程有限责任公司十大杰出贡献员工推荐名单</h2>
    <p>...</p>
    <th:block th:each="listInfo:${stringListMap}">
        <div class="panel panel-primary" >
            <div class="panel-heading">
                <div>
                    <h3 class="panel-title">
                        <th:block th:text="${listInfo.key+'&nbsp;&nbsp;&nbsp;'}"></th:block>
                        <small th:text="${'请选出'+#lists.size(listInfo.value)/2+'人'}"></small>
                    </h3>
                </div>
            </div>
            <div class="panel-body row" style="margin: -10px">
                <th:block th:each="showUserInfo,infoStat : ${listInfo.value}">
                    <div class="thumbnail col-xs-6">
                        <h4 class="text-center" th:text="${showUserInfo.id+'号'}">X</h4>
                        <img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9InllcyI/PjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMjQyIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDI0MiAyMDAiIHByZXNlcnZlQXNwZWN0UmF0aW89Im5vbmUiPjwhLS0KU291cmNlIFVSTDogaG9sZGVyLmpzLzEwMCV4MjAwCkNyZWF0ZWQgd2l0aCBIb2xkZXIuanMgMi42LjAuCkxlYXJuIG1vcmUgYXQgaHR0cDovL2hvbGRlcmpzLmNvbQooYykgMjAxMi0yMDE1IEl2YW4gTWFsb3BpbnNreSAtIGh0dHA6Ly9pbXNreS5jbwotLT48ZGVmcz48c3R5bGUgdHlwZT0idGV4dC9jc3MiPjwhW0NEQVRBWyNob2xkZXJfMTY1ODlmMWVmNTggdGV4dCB7IGZpbGw6I0FBQUFBQTtmb250LXdlaWdodDpib2xkO2ZvbnQtZmFtaWx5OkFyaWFsLCBIZWx2ZXRpY2EsIE9wZW4gU2Fucywgc2Fucy1zZXJpZiwgbW9ub3NwYWNlO2ZvbnQtc2l6ZToxMnB0IH0gXV0+PC9zdHlsZT48L2RlZnM+PGcgaWQ9ImhvbGRlcl8xNjU4OWYxZWY1OCI+PHJlY3Qgd2lkdGg9IjI0MiIgaGVpZ2h0PSIyMDAiIGZpbGw9IiNFRUVFRUUiLz48Zz48dGV4dCB4PSI4OS44NTkzNzUiIHk9IjEwNS40Ij4yNDJ4MjAwPC90ZXh0PjwvZz48L2c+PC9zdmc+"
                             alt="100%x200">
                        <div class="caption text-center">
                            <h5 th:text="${showUserInfo.username}">...</h5>
                            <!--<p th:text="${showUserInfo.sex+'&nbsp;&nbsp;'+showUserInfo.age-->
                            <!--+'&nbsp;&nbsp;'+showUserInfo.department+'&nbsp;&nbsp;'+showUserInfo.company}">...</p>-->
                            <!--</div>-->
                            <!--<h5 th:text="${showUserInfo.achievement}">...</h5>-->
                            <!--<p th:text="${showUserInfo.glory}">...</p>-->
                            <p>
                                <button name="selectBtn" th:attr="data-type=${showUserInfo.type},data-id=${showUserInfo.id}"
                                        class="btn-default btn" role="button" >选择</button>
                                <button name="infoBtn" class="btn-default btn" role="button" >详情</button>
                            </p>
                        </div>
                    </div>
                </th:block>
            </div>
        </div>
    </th:block>

    <button class="btn btn-success" id="apply" style="width: 100%">投票</button>
    <div class="text-center" style="padding: 15px 0px 30px 0px">
        <iframe name="Copyright" width=100% height=100%
                marginwidth=0 marginheight=0 frameborder="no" border="0"  src="/src/Copyright.html" ></iframe>
    </div>
</div>
<div id="popover-content"></div>
<!-- jQuery (Bootstrap 的所有 JavaScript 插件都依赖 jQuery，所以必须放在前边) -->
<script src="https://cdn.bootcss.com/jquery/1.12.4/jquery.min.js"></script>
<!-- 加载 Bootstrap 的所有 JavaScript 插件。你也可以根据需要只加载单个插件。 -->
<script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
</body>
<script th:inline="javascript">
    /*<![CDATA[*/
    var typeArray = /*[[${listKeySet}]]*/ [];
    /*]]>*/
</script>
<script>
    $(function(){
        $("button[name='selectBtn']").on("click",function(){
            var type = $(this).data("type");
            var maxSize = $("button.btn[name='selectBtn'][data-type="+type+"]").length;
            var realSize = $("button.btn-primary[name='selectBtn'][data-type="+type+"]").length;

            if($(this).hasClass("btn-primary") || maxSize/2 > realSize){
                $(this).toggleClass(function(){
                    return "btn-primary";
                });
                if($(this).html() == "已选择"){
                    $(this).html("选择");
                }else{
                    $(this).html("已选择");
                }
            }else{
                $(this).popover({
                    content:""+type+"，已选择"+realSize+"名候选人！",
                    placement: "top",
                    trigger:"manual",
                    delay:
                        { show: 500, hide: 1000 }

                });
                $(this).popover('show');
            }
        });

        $("button[name='selectBtn']").on('blur', function () {
            $(this).popover('hide');
        });

        ;

        $("#apply").on('blur', function () {
            $(this).popover('hide');
        });

        $("#apply").popover({
            html: true,
            content:function(){
                return $("#popover-content").html();
            },
            placement: "top",
            trigger:"manual",
            delay:
                { show: 500, hide: 1000 }
        }).on("click",function(){
            if(typeArray.length==0){
                return false;
            }

            for(var i=0;i<typeArray.length;i++){
                var maxSize = $("button.btn[name='selectBtn'][data-type="+typeArray[i]+"]").length;
                var realSize = $("button.btn-primary[name='selectBtn'][data-type="+typeArray[i]+"]").length;
                if(maxSize/2 != realSize){
                    $("#popover-content").html(typeArray[i]+"，需选择"+maxSize/2+"名候选人！");

                    $(this).popover('show');
//                    $("button.btn[name='selectBtn'][data-type="+typeArray[i]+"]")[0].focus();
                    return false;
                }
            }

            var type = $(this).data("type");
            var maxSize = $("button.btn[name='selectBtn'][data-type="+type+"]").length;
            var realSize = $("button.btn-primary[name='selectBtn'][data-type="+type+"]").length;


            var ids = [];
            for(var i=0;i<$("button.btn-primary[name='selectBtn']").length;i++){
                ids.push($($("button.btn-primary[name='selectBtn']")[i]).data("id"));
            }

            $.ajax({
                type: 'POST',
                url: "/select/commit",
                data: {"ids":ids},
                success: function(data){
                    if(data.status){
                        window.top.location = data.forword;
                    }else{
                        $("#popover-content").html("投票异常"+data.error);
                        $("#apply").popover('show');
                    }
                }
            });

        });
    });
</script>
</html>